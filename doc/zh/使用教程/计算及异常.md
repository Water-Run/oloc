# 计算及异常  

本章节介绍使用具体的使用`oloc`进行计算操作,及获取计算的对应结果及异常等. 

## 计算  

> `oloc`目前只支持10进制的计算  

**`oloc`中的计算使用`calculate()`函数**.  
`calculate()`接受**两个参数**:  

- `expression`: `str` **需要计算的表达式**  
- `time_limit`: `float` **计算限时**(秒).缺省值为`1.0`,**修改需要显式的进行指明**.将限时设置为任意负数关闭则`oloc`永远不会抛出计算超时异常  

关于`time_limit`的更多信息和计算流的具体实现,见[项目说明](../项目说明/项目说明梗概.md).  

*示例:*  

```python
import oloc

oloc.calculate('1+2+3') # Output: 6 
oloc.calculate('1/2^2-3/4') # Output: -1/2
oloc.calculate('100!', time_limit=1) # except OlocTimeOutException 
```

## 注释  
`oloc`支持为表达式添加注释.当你有着大量的表达式进行分享时,是个足够有用的功能.  
在预处理中注释将被删除.  

> 获取结果中的注释信息:将结果转换为`dict`,并通过读取字段`expression`中存储的原始表达式获取注释  

### 结尾注释  
正如其名,**结尾注释只能添加到表达式的结尾**.使用`@`号进行声明,其后的内容即为注释.  
示例:   
`1+2+3 @This is a concluding note.`  

### 自由注释  
和结尾注释不同,**自由注释可以出现在表达式中的任意位置**.自由注释使用**两个`#`进行包裹**.  
示例:
`1/2-#A free comment located before the mixed fraction.#4_1/2`.  
在一个表达式中可以有任意多个自由注释.  

## 输出  

### 格式化过滤器  

对于`oloc`的输出结果,将经过过滤器进行统一的过滤,确保格式化.  

### 结果封装  

**计算函数`calculate()`的输出结果是封装至类`OlocResult`的实例**.由于其实现了魔术方法,可以将其当作`str`使用,也支持`int` `float` `list` `dict`的类型转化.  
`OlocResult`中的属性是私有的,包括原始表达式(`_expression`)和结果列表(`_result`).不过,可以通过类型转化获取各个元素.    

#### 转化为字符串(最常用)  

**一般情况下,我们在使用`oloc`时只需要其最终结果的字符串即可**.使用`str`可以显式的对`OlocResult`进行转化.  
> 转化为字符串实质上是获取`_result`列表的最后一项  

*示例:*  
```python
import oloc

num1 = oloc.calculate('1/2+π')
print(num1) # 1/2 + π
```

#### 转化为列表和字典  

**将`OlocResult`使用`list`转化为列表,可以获取从预处理结束开始顺序的各步骤计算结果**.  
而如果我们也想知道原始的表达式,则使用`dict`将`OlocResult`转化为字典.其包括字段`result`(即列表转化的结果)和`expression`(原始输入的表达式)两个字段的内容.  

> 转化为列表实际上是获取`_result`列表  

> 转化为字典实质上是`{'result': _result, 'expression': _expression}`  

*示例:*  
```python
import oloc

num1 = oloc.calculate('(10/20+2/4)*pi^5')
print(list(num1)) # ['(1 / 2 + 1 / 2) * π^5', '1 * π^5', 'π^5']
print(dict(num1)) # {'expression': '(10/20+2/4)*pi^5', 'result': ['(1 / 2 + 1 / 2) * π^5', '1 * π^5', 'π^5']}
```

#### 转化为数值  

**使用`float`将`OlocResult`转化为浮点值**.   

> 无理数转化的小数保留位数存储在`olocdata.ini`的键`retain_decimal_places`中,不修改的情况下,该值为7  

自定义无理数进行浮点转化时需要确保该无理数声明了转化值(使用`?`,见[数字](数字.md),同样符号也用于手动设置原生无理数的转化精度中).  
**`int()`转化结果基于浮点数转化**.  

*示例:*  
```python
import oloc

num1 = oloc.calculate('π?2')
print(float(num1)) # 3.14
print(int(num1)) # 3
```  

> 由于浮点数的不精确性,在转化为数值后,`oloc`将丧失原有的基于分数的结果精确性性质  

##### 转化为`python`原生`fractions`  
还有一种办法能够更好的保护`oloc`结果的精确性:**转化为`python`原生的分数格式`fractions`**.  
只需调用`OlocResult`提供的方法`get_fractions()`即可.其返回`fractions`类型的值.  

*示例:*  
```python
import oloc

num1 = oloc.calculate('3/4')
print(num1.get_fractions().numerator) # 3
print(num1.get_fractions().denominator) # 4
```

> 由于`fractions`不兼容无理数,对于无理数的处理和转换为浮点数时一致  

## 异常  

在`oloc`中,异常的抽象基类是`OlocException`.  

### 预处理异常  

- `OlocFreeCommentException`  
    - *产生于*  
        - 当自由注释未闭合时(即存在奇数个`#`)  
    - *示例*
        - ```plaintext
          OlocFreeCommentException: Mismatch '#' detected
          123#unclosed+456
             ^
          Note: The content of free comments should be wrapped in a before and after '#'.
          ```

### 静态检查异常  

### 计算异常  

### 超时异常  

- ***超时异常*** `OlocTimeOutException`  
    - *产生于*  
        - 当计算耗时超过`time_limit`时  
    - *示例*  
        - ```plaintext
          OlocTimeOutException: Calculation time exceeds the set maximum time of 1.0s 
          100!
          ^^^^   
          Note: Check your expression or modify time_limit to a larger value  
          ```

> 关于错误指示器:如果异常是针对表达式的某个特定部位的,则以`^`指出对应的部位;如果异常是针对整个表达式的,则以`=`标注整个表达式.  

---  
***下一章节:[科学计算器CLI](科学计算器CLI.md)***  
*[返回目录](使用教程目录.md)*  