# 语法分析器

语法分析器是`oloc`在执行运算时的第三个子程序，负责将Token流构造为AST抽象语法树。  
语法分析器位于`oloc_parser.py`。  
语法分析器实例于`Parser`类。  

## 关于抽象语法树

抽象语法树(AST)通过`ASTTree`和`ASTNode`两个类进行实现。

### ASTNode
`ASTNode`类是抽象语法树的节点，包括以下**属性**：  

1. `type`: `TYPE` 节点的类型(见下)  
2. `tokens`: `list[Token]` 节点的Token列表
3. `children`: `list[ASTNode]` 节点的子节点列表
4. `parent`: `ASTNode` 节点的父节点

节点以以下进行**类型分类**：  

1. **表达式**  
    1. *二元表达式*: `BIN_EXP` - 包含两个操作数和一个操作符，如加减乘除等
    2. *一元表达式*: `URY_EXP` - 包含一个操作数和一个操作符，如正负号、根号、阶乘等
    3. *分组表达式*: `GRP_EXP` - 由括号包裹的表达式
2. **字面量**: `LITERAL` - 如整数、无理数等最基本的计算单元
3. **函数**: `FUN_CAL` - 函数调用，包含函数名和参数列表

### ASTTree
`ASTTree`类是抽象语法树的总体结构，包括以下**属性**：
1. `root`: `ASTNode` 树的根节点
2. `node_count`: `int` 树中的节点总数

#### 可视化与调试

AST的`__repr__`方法提供了树结构的可视化表示，便于调试和理解表达式的结构。例如，表达式`1 + 2 * 3`将被可视化为：

```
AST Tree:
└── BIN_EXP(+)
    ├── LITERAL(1)
    └── BIN_EXP(*)
        ├── LITERAL(2)
        └── LITERAL(3)
```

## 输入输出  

语法分析器接受一个参数：

- `tokens`:`list[Token]` 输入的Token流  

语法分析器的处理结果为`ASTTree`,存储于`self.ast`，即构建好的抽象语法树。  

## 工作流  

语法分析器按顺序依次执行如下内容：  

1. ***静态检查***  
   - **功能**  
     - 扫描表达式，检查有无遗漏的错误格式  
   - **实现**
     - 检查Token流是否为空。如果为空，补全缺省结果为0  
     - 非法Token类型检查  
     - 非法运算符检查，包括运算符的位置和组合是否符合规则  
     - 非法函数名检查，验证函数名是否存在于函数映射表中  
     - 非法函数参数分隔符检查，确保分隔符使用正确  
     - 非法括号检查，确保左右括号匹配  
     - 非法无理数参数检查，确保无理数参数格式正确  
   - **示例**  
      - *输入*: `['5', '+', '(', '6', '*', '(', '3', '+', '4', ')', ')']`  
      - *输出*: (无异常，表示检查通过)  
   - **异常**  
      - `OlocSyntaxError`: 当存在非法的运算符，括号或函数时，或类型错误时  

2. ***AST构建***  
   - **功能**  
      - 根据Token流，构建抽象语法树      
   - **实现**  
      - 使用递归下降解析结合运算符优先级分析的方法
      - 定义不同优先级层次的解析函数：
         - `_parse_expression`：处理整个表达式，从最低优先级开始
         - `_parse_add_sub`：处理加减法表达式
         - `_parse_mul_div`：处理乘除法和取余表达式
         - `_parse_power`：处理幂运算表达式
         - `_parse_unary`：处理一元运算符表达式
         - `_parse_primary`：处理基本元素（数字、函数调用、分组表达式）
         - `_parse_function_params`：解析函数参数
      - 按照运算符优先级从低到高递归构建树
   - **示例**  
      - *输入*: `["1", "+", "2", "*", "3"]`  
      - *输出*: 一棵AST，表示`1 + (2 * 3)`，其中`+`为根节点，左子树为`1`，右子树为`2 * 3`
   - **异常**  
      - `OlocSyntaxError`: 当Token流不能形成有效的表达式时

3. ***语法语义检查***  
   - **功能**  
      - 检查构建好的AST在语法和语义上是否合法      
   - **实现**  
      - 深度优先遍历AST
      - 对每个节点根据其类型进行检查：
         - 二元表达式：检查是否有两个操作数和一个操作符
         - 一元表达式：检查是否有一个操作数和一个操作符
         - 函数调用：检查函数参数数量是否匹配函数定义
         - 分组表达式：检查内部表达式是否合法
      - 确保操作数和操作符匹配，函数调用参数正确
   - **异常**  
      - `OlocSyntaxError`: 当AST中存在语法或语义错误时

## 运算符优先级

oloc语法分析器在构建AST时遵循以下运算符优先级规则（从高到低）：

1. **分组运算符** - `()`, `[]`, `{}`
2. **一元运算符** - 前置：`+`, `-`, `√`；后置：`!`, `°`
3. **幂运算** - `^` (右结合)
4. **乘除与取余** - `*`, `/`, `%` (左结合)
5. **加减** - `+`, `-` (左结合)

## 函数处理

对于函数调用，语法分析器特别处理以下情况：

1. **参数分割** - 使用`,`分割的参数列表
2. **嵌套函数** - 函数参数中包含其他函数调用
3. **参数数量验证** - 根据函数定义验证参数数量是否正确

---
***[点此](../项目说明梗概.md)跳转回说明梗概页面***
