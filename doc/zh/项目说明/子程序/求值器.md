# 求值器

求值器是`oloc`在执行运算时的第四个子程序，负责计算表达式的结果。  
求值器位于`oloc_evaluator.py`。  
求值器实例于`Evaluator`类(其中，基础计算实例于`Calculation`类,函数实例于`Function`类)。  

## 公有的静态方法  

### `Calculation`中的静态方法

- `addition`  
    - **说明**  
        - 计算加法运算  
    - **参数**  
        - `augend`:`list[Token]` 被加数  
        - `addend`:`list[Token]` 加数  
    - **实现**  
        - 处理特殊情况：任一操作数为0  
        - 处理整数和分数的加法  
        - 处理同类型变量的加法（如x+x=2*x）  
        - 处理系数变量相加（如a*x+b*x=(a+b)*x）  
        - 无法化简时保持原始表达式形式  
    - **返回值**  
        - 加法运算的结果:`list[Token]`  

- `subtraction`  
    - **说明**  
        - 计算减法运算  
    - **参数**  
        - `minuend`:`list[Token]` 被减数  
        - `subtrahend`:`list[Token]` 减数  
    - **实现**  
        - 处理特殊情况：减数或被减数为0  
        - 处理整数和分数的减法  
        - 处理同类型变量的减法（如x-x=0）  
        - 处理系数变量相减（如a*x-b*x=(a-b)*x）  
        - 复杂表达式加括号处理  
    - **返回值**  
        - 减法运算的结果:`list[Token]`  

- `multiplication`  
    - **说明**  
        - 计算乘法运算  
    - **参数**  
        - `factor_1`:`list[Token]` 因数1  
        - `factor_2`:`list[Token]` 因数2  
    - **实现**  
        - 处理特殊情况：任一因数为0或1  
        - 处理整数和分数的乘法  
        - 处理无理数乘法的特殊情况（如π*π=π^2）  
        - 处理同类变量幂的乘法（如x^a*x^b=x^(a+b)）  
        - 处理变量与数值的乘法，标准化为数值*变量形式  
        - 处理系数变量相乘（如(a*x)*(b*y)=(a*b)*(x*y)）  
    - **返回值**  
        - 乘法运算的结果:`list[Token]`  

- `division`  
    - **说明**  
        - 计算除法运算，结果化至最简形式  
    - **参数**  
        - `dividend`:`list[Token]` 被除数  
        - `divisor`:`list[Token]` 除数  
    - **实现**  
        - 错误处理：除数为0时抛出异常  
        - 处理特殊情况：被除数为0或除数为1  
        - 处理整数和分数的除法  
        - 处理变量与整数/分数的除法  
        - 处理幂与除法的关系（如x^a/x^b=x^(a-b)）  
        - 处理同类无理数相除（如x/x=1）  
        - 处理系数变量相除（如(a*x)/(b*y)=(a/b)*(x/y)）  
        - 复杂表达式的括号处理  
    - **返回值**  
        - 除法运算的结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 除数为0时  

- `negate_expression`  
    - **说明**  
        - 对表达式取反  
    - **参数**  
        - `tokens`:`list[Token]` 要取反的表达式  
    - **实现**  
        - 整数取反直接计算  
        - 分数取反处理分子  
        - 复杂表达式添加负号和括号  
    - **返回值**  
        - 取反后的表达式:`list[Token]`  

- `create_fraction`  
    - **说明**  
        - 创建分数Token列表，自动化简  
    - **参数**  
        - `numerator`:`int` 分子  
        - `denominator`:`int` 分母  
    - **实现**  
        - 检查分母是否为0  
        - 计算最大公约数进行约分  
        - 处理负号情况  
        - 分母为1返回整数结果  
        - 生成分数Token列表  
    - **返回值**  
        - 分数Token列表:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 分母为0时  

- `is_zero`  
    - **说明**  
        - 判断Token列表是否表示0  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否表示0:`bool`  

- `is_one`  
    - **说明**  
        - 判断Token列表是否表示1  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否表示1:`bool`  

- `is_numeric`  
    - **说明**  
        - 判断Token列表是否表示纯数值（整数或分数）  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否是纯数值:`bool`  

- `to_fraction`  
    - **说明**  
        - 将Token列表转换为分数表示  
    - **参数**  
        - `tokens`:`list[Token]` 待转换的Token列表  
    - **返回值**  
        - 分子和分母的元组:`tuple[int, int]`  
    - **异常**  
        - `ValueError`: 无法转换为分数时  

- `add_numeric`  
    - **说明**  
        - 处理纯数值（整数或分数）的加法  
    - **参数**  
        - `a`:`list[Token]` 被加数  
        - `b`:`list[Token]` 加数  
    - **返回值**  
        - 加法结果:`list[Token]`  

- `multiply_numeric`  
    - **说明**  
        - 处理纯数值（整数或分数）的乘法  
    - **参数**  
        - `a`:`list[Token]` 因数1  
        - `b`:`list[Token]` 因数2  
    - **返回值**  
        - 乘法结果:`list[Token]`  

- `get_reciprocal`  
    - **说明**  
        - 计算倒数  
    - **参数**  
        - `tokens`:`list[Token]` 待求倒数的Token列表  
    - **返回值**  
        - 倒数结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当原数为0时  

- `_is_coefficient_variable`  
    - **说明**  
        - 判断Token列表是否表示系数乘以变量的形式（如2*x）  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否是系数乘以变量形式:`bool`  

- `_get_coefficient`  
    - **说明**  
        - 获取系数乘以变量形式中的系数部分  
    - **参数**  
        - `tokens`:`list[Token]` 系数乘以变量形式的Token列表  
    - **返回值**  
        - 系数部分的Token列表:`list[Token]`  

- `_get_variable`  
    - **说明**  
        - 获取系数乘以变量形式中的变量部分  
    - **参数**  
        - `tokens`:`list[Token]` 系数乘以变量形式的Token列表  
    - **返回值**  
        - 变量部分的Token:`Token`  

- `_is_variable_power`  
    - **说明**  
        - 判断Token列表是否表示变量的幂形式（如x^2）  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否是变量的幂形式:`bool`  

- `_get_power_base`  
    - **说明**  
        - 获取变量的幂形式中的底数（变量）部分  
    - **参数**  
        - `tokens`:`list[Token]` 变量的幂形式的Token列表  
    - **返回值**  
        - 底数部分的Token:`Token`  

- `_get_power_exponent`  
    - **说明**  
        - 获取变量的幂形式中的指数部分  
    - **参数**  
        - `tokens`:`list[Token]` 变量的幂形式的Token列表  
    - **返回值**  
        - 指数部分的Token列表:`list[Token]`  

### `Function.Pow`中的静态方法  

- `pow`  
    - **说明**  
        - 计算指数函数  
    - **参数**  
        - `x`:`list[Token]` 底数Token流  
        - `y`:`list[Token]` 指数Token流  
    - **实现**  
        - 处理特殊情况：0^0（undefined）、x^0、x^1、0^y、1^y  
        - 处理特殊情况：e^(ln(x)) = x  
        - 处理负整数次幂  
        - 处理整数的整数次幂  
        - 处理分数的整数次幂  
        - 处理整数的分数次幂（开方）  
        - 处理幂次叠加（(x^a)^b=x^(a*b)）  
        - 处理无理数的简单指数  
        - 无法直接计算时保持原始表达式形式  
    - **返回值**  
        - 幂运算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当出现0^0情况时  

- `sqrt`  
    - **说明**  
        - 计算平方根函数  
    - **参数**  
        - `x`:`list[Token]` 被开方数Token流  
    - **实现**  
        - 处理特殊情况：√0=0、√1=1、完全平方数  
        - 调用pow函数实现，等价于x^(1/2)  
    - **返回值**  
        - 平方根计算结果:`list[Token]`  

- `sq`  
    - **说明**  
        - 计算平方函数  
    - **参数**  
        - `x`:`list[Token]` 被平方数Token流  
    - **实现**  
        - 调用pow函数实现，等价于x^2  
    - **返回值**  
        - 平方计算结果:`list[Token]`  

- `cub`  
    - **说明**  
        - 计算立方函数  
    - **参数**  
        - `x`:`list[Token]` 被立方数Token流  
    - **实现**  
        - 调用pow函数实现，等价于x^3  
    - **返回值**  
        - 立方计算结果:`list[Token]`  

- `rec`  
    - **说明**  
        - 计算倒数函数  
    - **参数**  
        - `x`:`list[Token]` 被求倒数Token流  
    - **实现**  
        - 调用pow函数实现，等价于x^(-1)  
    - **返回值**  
        - 倒数计算结果:`list[Token]`  

### `Function.Trig`中的静态方法

- `sin`  
    - **说明**  
        - 计算正弦函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 处理特殊角度值（如π/6、π/4、π/3等）  
        - 处理整数角度（如0°、90°、180°等）  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 正弦计算结果:`list[Token]`  

- `cos`  
    - **说明**  
        - 计算余弦函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 处理特殊角度值  
        - 处理整数角度  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 余弦计算结果:`list[Token]`  

- `tan`  
    - **说明**  
        - 计算正切函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 处理特殊角度值  
        - 检查无效角度（如π/2+nπ）  
        - 处理整数角度  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 正切计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当角度为无效值时  

- `csc`  
    - **说明**  
        - 计算余割函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 计算正弦函数的结果，然后取倒数  
    - **返回值**  
        - 余割计算结果:`list[Token]`  

- `sec`  
    - **说明**  
        - 计算正割函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 计算余弦函数的结果，然后取倒数  
    - **返回值**  
        - 正割计算结果:`list[Token]`  

- `cot`  
    - **说明**  
        - 计算余切函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 处理特殊角度值  
        - 检查无效角度（如0或π）  
        - 计算正切函数的结果，然后取倒数  
    - **返回值**  
        - 余切计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当角度为无效值时  

- `asin`  
    - **说明**  
        - 计算反正弦函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 处理特殊值  
        - 检查定义域（-1≤x≤1）  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 反正弦计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数超出定义域时  

- `acos`  
    - **说明**  
        - 计算反余弦函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 处理特殊值  
        - 检查定义域（-1≤x≤1）  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 反余弦计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数超出定义域时  

- `atan`  
    - **说明**  
        - 计算反正切函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 处理特殊值  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 反正切计算结果:`list[Token]`  

- `degrees_to_radians`  
    - **说明**  
        - 度数转弧度  
    - **参数**  
        - `x`:`list[Token]` 度数Token流  
    - **实现**  
        - 处理特殊角度值（如30°、45°、60°等）  
        - 处理一般度数，转换为弧度的分数形式  
        - 无法直接计算时添加π/180系数  
    - **返回值**  
        - 弧度值:`list[Token]`  

### `Function.Log`中的静态方法

- `log`  
    - **说明**  
        - 计算对数函数  
    - **参数**  
        - `base`:`list[Token]` 底数Token流  
        - `x`:`list[Token]` 真数Token流  
    - **实现**  
        - 检查参数有效性（x>0, base>0, base≠1）  
        - 处理特殊情况（如log(1)=0、log(base)=1）  
        - 处理幂运算关系（如log(x^n)=n*log(x)）  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 对数计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数无效时  

- `ln`  
    - **说明**  
        - 计算自然对数函数  
    - **参数**  
        - `x`:`list[Token]` 真数Token流  
    - **实现**  
        - 使用e为底数的对数函数  
    - **返回值**  
        - 自然对数计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当真数≤0时  

- `lg`  
    - **说明**  
        - 计算常用对数函数（以10为底）  
    - **参数**  
        - `x`:`list[Token]` 真数Token流  
    - **实现**  
        - 使用10为底数的对数函数  
    - **返回值**  
        - 常用对数计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当真数≤0时  

- `exp`  
    - **说明**  
        - 计算自然指数函数e^x  
    - **参数**  
        - `x`:`list[Token]` 指数Token流  
    - **实现**  
        - 调用pow函数，使用e作为底数  
    - **返回值**  
        - 自然指数计算结果:`list[Token]`  

### `Function.Other`中的静态方法

- `abs`  
    - **说明**  
        - 计算绝对值函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 处理整数和分数的绝对值  
        - 处理带符号的变量和无理数  
        - 处理负数表达式  
        - 无法直接计算时保持函数形式  
    - **返回值**  
        - 绝对值计算结果:`list[Token]`  

- `fact`  
    - **说明**  
        - 计算阶乘函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 检查参数是否为非负整数  
        - 计算阶乘结果  
        - 处理特殊情况（0!=1）  
        - 结果太大时保持函数形式  
    - **返回值**  
        - 阶乘计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数不是非负整数时  

- `gcd`  
    - **说明**  
        - 计算最大公约数  
    - **参数**  
        - `a`:`list[Token]` 第一个参数Token流  
        - `b`:`list[Token]` 第二个参数Token流  
    - **实现**  
        - 检查参数是否为整数  
        - 计算最大公约数  
    - **返回值**  
        - 最大公约数计算结果:`list[Token]`  

- `lcm`  
    - **说明**  
        - 计算最小公倍数  
    - **参数**  
        - `a`:`list[Token]` 第一个参数Token流  
        - `b`:`list[Token]` 第二个参数Token流  
    - **实现**  
        - 检查参数是否为整数  
        - 处理特殊情况（如任一数为0时LCM为0）  
        - 计算最小公倍数  
    - **返回值**  
        - 最小公倍数计算结果:`list[Token]`  

- `mod`  
    - **说明**  
        - 计算模运算（取余）  
    - **参数**  
        - `a`:`list[Token]` 被除数Token流  
        - `b`:`list[Token]` 除数Token流  
    - **实现**  
        - 检查除数是否为0  
        - 检查参数是否为整数  
        - 计算模运算结果  
    - **返回值**  
        - 模运算计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当除数为0时  

- `sign`  
    - **说明**  
        - 计算符号函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 处理整数和分数的符号  
        - 处理负数表达式  
        - 无法确定符号的情况保持函数形式  
    - **返回值**  
        - 符号函数计算结果:`list[Token]`  

## 节点求值策略类

- `NodeEvaluator`  
    - **说明**  
        - 节点求值策略的基类  
    - **静态方法**  
        - `evaluate`: 评估节点  
        - **参数**  
            - `node`: `ASTNode` 要评估的节点  
            - `evaluator`: `Evaluator` 求值器实例  
        - **返回值**  
            - 计算结果的Token列表: `list[Token]`  

- `LiteralEvaluator`  
    - **说明**  
        - 字面量节点求值策略  
    - **实现**  
        - 直接返回节点的token  

- `GroupExpressionEvaluator`  
    - **说明**  
        - 分组表达式节点求值策略  
    - **实现**  
        - 检查子节点数量是否为1  
        - 计算括号内的表达式  
        - 返回内部结果  

- `BinaryExpressionEvaluator`  
    - **说明**  
        - 二元表达式节点求值策略  
    - **实现**  
        - 检查子节点数量是否为2  
        - 获取操作符  
        - 计算左右子表达式  
        - 根据操作符执行相应的计算  

- `UnaryExpressionEvaluator`  
    - **说明**  
        - 一元表达式节点求值策略  
    - **实现**  
        - 检查子节点数量是否为1  
        - 获取操作符  
        - 计算操作数  
        - 应用一元运算符  

- `FunctionCallEvaluator`  
    - **说明**  
        - 函数调用节点求值策略  
    - **实现**  
        - 获取函数名  
        - 计算所有参数  
        - 检查函数是否支持  
        - 检查参数数量  
        - 调用相应的函数  

## 输入输出  

求值器接受三个参数。  

- `expression`：`str` 输入的表达式(与上一步一致)  
- `tokens`：`list[Token]` 输入的Token流(与上一步一致)  
- `ast`：`ASTTree` 输入的AST树  

求值器的处理结果存储在`self.result`中，是一个包括逐步计算结果的`list[list[Token]]`列表。同时，`self.tokens`，`self.expression`也会更新为最新的结果。    

## 工作流  

求值器按顺序依次执行如下内容。  

1. ***初始化阶段***  
   - **功能**  
      - 设置求值环境和数据结构  
   - **实现**  
      - 记录原始表达式和Tokens  
      - 初始化结果列表和中间状态记录  
      - 初始化计算事件管理和步骤管理器  
      - 初始化特殊值表（如三角函数特殊角度值）  
   - **示例**  
      - *初始tokens*: `[Token(INTEGER, "1", [0, 0]), Token(OPERATOR, "+", [1, 1]), Token(INTEGER, "2", [2, 2])]`  
      - *初始expression*: `"1+2"`  

2. ***AST树递归求值***  
   - **功能**  
      - 根据AST树的结构递归计算表达式的值  
   - **实现**  
      - 为节点生成原始表示  
      - 记录节点开始计算事件  
      - 根据节点类型选择求值策略  
      - 记录节点计算结果  
      - 记录节点完成计算事件  
      - 记录有意义的计算步骤  
   - **示例**  
      - *输入*: AST树（表示`1+2*3`）  
      - *输出*: `[Token(INTEGER, "7", [0, 0])]`
   - **异常**  
      - `OlocCalculationError`: 当计算过程出现错误（如除零、无效运算）时  

3. ***计算步骤生成***  
    - **功能**  
      - 生成清晰、连贯的计算步骤  
    - **实现**   
      - 获取所有步骤完成事件  
      - 按照计算顺序排序步骤  
      - 处理嵌套函数和表达式的特殊情况  
      - 生成每一步的完整表达式  
      - 简化表达式中不必要的括号  
      - 添加到步骤管理器  
    - **示例**  
      - *输入*: `1+2*3`  
      - *输出*: `[[1, +, 2, *, 3], [1, +, 6], [7]]`  

4. ***结果优化***  
   - **功能**  
      - 优化计算步骤，移除不必要的步骤  
   - **实现**
      - 调用步骤管理器的优化方法  
      - 保留原始表达式和最终结果  
      - 移除表达式变化很小的中间步骤  
   - **示例**  
      - *优化前*: `[[1, +, 2, *, 3], [1, +, 2, *, 3], [1, +, 6], [7]]`  
      - *优化后*: `[[1, +, 2, *, 3], [1, +, 6], [7]]`  

5. ***最终结果更新***  
   - **功能**  
      - 更新最终表达式和Tokens  
   - **实现**  
      - 使用最终计算结果更新`self.tokens`  
      - 更新`self.expression`为对应的字符串  
   - **示例**  
      - *最终tokens*: `[Token(INTEGER, "7", [0, 0])]`  
      - *最终expression*: `"7"`  

---
***[点此](../项目说明梗概.md)跳转回说明梗概页面***
