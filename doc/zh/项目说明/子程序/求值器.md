# 求值器

求值器是`oloc`在执行运算时的第四个子程序，负责计算表达式的结果。  
求值器位于`oloc_evaluator.py`。  
求值器实例于`Evaluator`类(其中，基础计算实例于`Calculation`类,函数实例于`Function`类)。  

## 公有的静态方法  

### `Calculation`中的静态方法

- `addition`  
    - **说明**  
        - 计算加法运算  
    - **参数**  
        - `augend`:`list[Token]` 被加数  
        - `addend`:`list[Token]` 加数  
    - **实现**  
        - 处理特殊情况：任一操作数为0  
        - 处理整数和分数的加法  
        - 处理同类型变量的加法（如x+x=2*x）  
        - 无法化简的情况保持原始表达式形式  
    - **返回值**  
        - 加法运算的结果:`list[Token]`  

- `subtraction`  
    - **说明**  
        - 计算减法运算  
    - **参数**  
        - `minuend`:`list[Token]` 被减数  
        - `subtrahend`:`list[Token]` 减数  
    - **实现**  
        - 处理特殊情况：减数或被减数为0  
        - 处理整数和分数的减法  
        - 处理同类型变量的减法（如x-x=0）  
        - 复杂表达式加括号处理  
    - **返回值**  
        - 减法运算的结果:`list[Token]`  

- `multiplication`  
    - **说明**  
        - 计算乘法运算  
    - **参数**  
        - `factor_1`:`list[Token]` 因数1  
        - `factor_2`:`list[Token]` 因数2  
    - **实现**  
        - 处理特殊情况：任一因数为0或1  
        - 处理整数和分数的乘法  
        - 处理变量与数值的乘法，标准化为数值*变量形式  
    - **返回值**  
        - 乘法运算的结果:`list[Token]`  

- `division`  
    - **说明**  
        - 计算除法运算，结果化至最简形式  
    - **参数**  
        - `dividend`:`list[Token]` 被除数  
        - `divisor`:`list[Token]` 除数  
    - **实现**  
        - 错误处理：除数为0时抛出异常  
        - 处理特殊情况：被除数为0或除数为1  
        - 处理整数和分数的除法  
        - 处理变量与整数/分数的除法  
        - 复杂表达式的括号处理  
    - **返回值**  
        - 除法运算的结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 除数为0时  

- `negate_expression`  
    - **说明**  
        - 对表达式取反  
    - **参数**  
        - `tokens`:`list[Token]` 要取反的表达式  
    - **实现**  
        - 整数取反直接计算  
        - 分数取反处理分子  
        - 复杂表达式添加负号和括号  
    - **返回值**  
        - 取反后的表达式:`list[Token]`  

- `create_fraction`  
    - **说明**  
        - 创建分数Token列表，自动化简  
    - **参数**  
        - `numerator`:`int` 分子  
        - `denominator`:`int` 分母  
    - **实现**  
        - 检查分母是否为0  
        - 计算最大公约数进行约分  
        - 处理负号情况  
        - 分母为1返回整数结果  
        - 生成分数Token列表  
    - **返回值**  
        - 分数Token列表:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 分母为0时  

- `is_zero`  
    - **说明**  
        - 判断Token列表是否表示0  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否表示0:`bool`  

- `is_one`  
    - **说明**  
        - 判断Token列表是否表示1  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否表示1:`bool`  

- `is_numeric`  
    - **说明**  
        - 判断Token列表是否表示纯数值（整数或分数）  
    - **参数**  
        - `tokens`:`list[Token]` 待判断的Token列表  
    - **返回值**  
        - 是否是纯数值:`bool`  

- `to_fraction`  
    - **说明**  
        - 将Token列表转换为分数表示  
    - **参数**  
        - `tokens`:`list[Token]` 待转换的Token列表  
    - **返回值**  
        - 分子和分母的元组:`tuple[int, int]`  
    - **异常**  
        - `ValueError`: 无法转换为分数时  

- `add_numeric`  
    - **说明**  
        - 处理纯数值（整数或分数）的加法  
    - **参数**  
        - `a`:`list[Token]` 被加数  
        - `b`:`list[Token]` 加数  
    - **返回值**  
        - 加法结果:`list[Token]`  

- `multiply_numeric`  
    - **说明**  
        - 处理纯数值（整数或分数）的乘法  
    - **参数**  
        - `a`:`list[Token]` 因数1  
        - `b`:`list[Token]` 因数2  
    - **返回值**  
        - 乘法结果:`list[Token]`  

- `get_reciprocal`  
    - **说明**  
        - 计算倒数  
    - **参数**  
        - `tokens`:`list[Token]` 待求倒数的Token列表  
    - **返回值**  
        - 倒数结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当原数为0时  

### `Function.Pow`中的静态方法  

- `pow`  
    - **说明**  
        - 计算指数函数  
    - **参数**  
        - `x`:`list[Token]` 底数Token流  
        - `y`:`list[Token]` 指数Token流  
    - **实现**  
        - 处理特殊情况：0^0（undefined）、x^0、x^1、0^y、1^y  
        - 处理整数的整数次幂  
        - 处理分数的整数次幂  
        - 无法直接计算时保持原始表达式形式  
    - **返回值**  
        - 幂运算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当出现0^0情况时  

- `sqrt`  
    - **说明**  
        - 计算平方根函数  
    - **参数**  
        - `x`:`list[Token]` 被开方数Token流  
    - **实现**  
        - 处理特殊情况：√0=0、√1=1、完全平方数  
        - 调用pow函数实现，等价于x^(1/2)  
    - **返回值**  
        - 平方根计算结果:`list[Token]`  

- `sq`  
    - **说明**  
        - 计算平方函数  
    - **参数**  
        - `x`:`list[Token]` 被平方数Token流  
    - **实现**  
        - 调用pow函数实现，等价于x^2  
    - **返回值**  
        - 平方计算结果:`list[Token]`  

- `cub`  
    - **说明**  
        - 计算立方函数  
    - **参数**  
        - `x`:`list[Token]` 被立方数Token流  
    - **实现**  
        - 调用pow函数实现，等价于x^3  
    - **返回值**  
        - 立方计算结果:`list[Token]`  

- `rec`  
    - **说明**  
        - 计算倒数函数  
    - **参数**  
        - `x`:`list[Token]` 被求倒数Token流  
    - **实现**  
        - 调用pow函数实现，等价于x^(-1)  
    - **返回值**  
        - 倒数计算结果:`list[Token]`  

### `Function.Trig`中的静态方法

- `sin`  
    - **说明**  
        - 计算正弦函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 处理特殊角度值（如π/6、π/4、π/3等）  
        - 支持度数和弧度单位  
        - 无法直接计算时保持原始表达式形式  
    - **返回值**  
        - 正弦计算结果:`list[Token]`  

- `cos`  
    - **说明**  
        - 计算余弦函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 处理特殊角度值  
        - 支持度数和弧度单位  
        - 无法直接计算时保持原始表达式形式  
    - **返回值**  
        - 余弦计算结果:`list[Token]`  

- `tan`  
    - **说明**  
        - 计算正切函数  
    - **参数**  
        - `x`:`list[Token]` 角度Token流  
    - **实现**  
        - 处理特殊角度值  
        - 检查无效角度（如π/2+nπ）  
        - 支持度数和弧度单位  
    - **返回值**  
        - 正切计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当角度为无效值时  

### `Function.Log`中的静态方法

- `log`  
    - **说明**  
        - 计算对数函数  
    - **参数**  
        - `base`:`list[Token]` 底数Token流  
        - `x`:`list[Token]` 真数Token流  
    - **实现**  
        - 处理特殊情况（如log(1)=0、log(base)=1）  
        - 检查参数有效性（底数>0且≠1，真数>0）  
        - 无法直接计算时保持原始表达式形式  
    - **返回值**  
        - 对数计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数无效时  

- `ln`  
    - **说明**  
        - 计算自然对数（以e为底）  
    - **参数**  
        - `x`:`list[Token]` 真数Token流  
    - **实现**  
        - 处理特殊情况（如ln(e)=1、ln(e^n)=n）  
        - 检查参数有效性（真数>0）  
        - 调用log函数，使用e作为底数  
    - **返回值**  
        - 自然对数计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当真数≤0时  

### `Function.Other`中的静态方法

- `abs`  
    - **说明**  
        - 计算绝对值函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 处理数值的绝对值计算  
        - 处理带符号的无理数  
        - 处理复杂表达式  
    - **返回值**  
        - 绝对值计算结果:`list[Token]`  

- `fact`  
    - **说明**  
        - 计算阶乘函数  
    - **参数**  
        - `x`:`list[Token]` 参数Token流  
    - **实现**  
        - 检查参数是否为非负整数  
        - 计算阶乘结果  
        - 处理特殊情况（0!=1）  
    - **返回值**  
        - 阶乘计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数不是非负整数时  

- `gcd`  
    - **说明**  
        - 计算最大公约数  
    - **参数**  
        - `a`:`list[Token]` 第一个参数Token流  
        - `b`:`list[Token]` 第二个参数Token流  
    - **实现**  
        - 检查参数是否为整数  
        - 计算最大公约数  
        - 处理特殊情况（如0与任何数的最大公约数）  
    - **返回值**  
        - 最大公约数计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数不是整数时  

- `lcm`  
    - **说明**  
        - 计算最小公倍数  
    - **参数**  
        - `a`:`list[Token]` 第一个参数Token流  
        - `b`:`list[Token]` 第二个参数Token流  
    - **实现**  
        - 检查参数是否为整数  
        - 计算最小公倍数  
        - 处理特殊情况（如0与任何数的最小公倍数为0）  
    - **返回值**  
        - 最小公倍数计算结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 当参数不是整数时  

## 输入输出  

求值器接受三个参数。  

- `expression`：`str` 输入的表达式(与上一步一致)  
- `tokens`：`list[Token]` 输入的Token流(与上一步一致)  
- `ast`：`ASTTree` 输入的AST树  

求值器的处理结果存储在`self.result`中，是一个包括逐步计算结果的`list[list[Token]]`列表。同时，`self.tokens`，`self.expression`也会更新为最新的结果。    

## 工作流  

求值器按顺序依次执行如下内容。  

1. ***初始化阶段***  
   - **功能**  
      - 设置求值环境和数据结构  
   - **实现**  
      - 记录原始表达式和Tokens  
      - 初始化结果列表和中间状态记录  
      - 设置计算事件管理器  
   - **示例**  
      - *初始tokens*: `[Token(INTEGER, "1", [0, 0]), Token(OPERATOR, "+", [1, 1]), Token(INTEGER, "2", [2, 2])]`  
      - *初始expression*: `"1+2"`  

2. ***AST树递归求值***  
   - **功能**  
      - 根据AST树的结构递归计算表达式的值  
   - **实现**  
      - 采用后序遍历，先计算子节点再计算父节点  
      - 为每种节点类型使用专门的求值策略  
      - 记录每个节点的原始表示和计算结果  
      - 实现表达式的自动化简（如合并同类项）  
   - **示例**  
      - *输入*: AST树（表示`1+2*3`）  
      - *输出*: `[Token(INTEGER, "7", [0, 0])]`
   - **异常**  
      - `OlocCalculationError`: 当计算过程出现错误（如除零、无效运算）时  

3. ***计算步骤生成***  
    - **功能**  
      - 生成清晰、连贯的计算步骤  
    - **实现**   
      - 根据节点求值顺序生成计算步骤  
      - 只记录有意义的变化步骤  
      - 处理子表达式和中间结果的替换  
      - 优化步骤，移除冗余括号，确保可读性  
    - **示例**  
      - *输入*: `1+2*3`  
      - *输出*: `[[1, +, 2, *, 3], [1, +, 6], [7]]`  

4. ***结果格式化***  
   - **功能**  
      - 将计算结果格式化为标准形式  
   - **实现**
      - 对结果表达式进行最终优化  
      - 确保结果为最简形式  
      - 确保括号使用正确且必要  
      - 更新最终表达式和Tokens  
   - **示例**  
      - *最终tokens*: `[Token(INTEGER, "7", [0, 0])]`  
      - *最终expression*: `"7"`

---
***[点此](../项目说明梗概.md)跳转回说明梗概页面***
