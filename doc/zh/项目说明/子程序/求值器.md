# 求值器

求值器是`oloc`在执行运算时的第四个子程序，负责计算表达式的结果。  
求值器位于`oloc_evaluator.py`。  
求值器实例于`Evaluator`类(其中，函数实例于`Function`类)。  

## 公有的静态方法  

求值器提供了以下公有的静态方法。  

> 将这些方法设计为公有的静态方法主要是为了未来的兼容性考虑  

### `Evaluator`中的静态方法  

`Evaluator`中的基本算术运算和表达式处理相关的内容作为静态方法。   

- `addition`  
    - **说明**  
        - 计算加法运算  
    - **参数**  
        - `augend`:`list[Token]` 被加数  
        - `addend`:`list[Token]` 加数  
    - **实现**  
        - 处理特殊情况：任一操作数为0  
        - 处理整数和分数的加法  
        - 处理同类型变量的加法（如x+x=2*x）  
        - 无法化简的情况保持原始表达式形式  
    - **返回值**  
        - 加法运算的结果:`list[Token]`  

- `subtraction`  
    - **说明**  
        - 计算减法运算  
    - **参数**  
        - `minuend`:`list[Token]` 被减数  
        - `subtrahend`:`list[Token]` 减数  
    - **实现**  
        - 处理特殊情况：减数或被减数为0  
        - 处理整数和分数的减法  
        - 处理同类型变量的减法（如x-x=0）  
        - 复杂表达式加括号处理  
    - **返回值**  
        - 减法运算的结果:`list[Token]`  

- `multiplication`  
    - **说明**  
        - 计算乘法运算  
    - **参数**  
        - `factor_1`:`list[Token]` 因数1  
        - `factor_2`:`list[Token]` 因数2  
    - **实现**  
        - 处理特殊情况：任一因数为0或1  
        - 处理整数和分数的乘法  
        - 处理变量与数值的乘法，标准化为数值*变量形式  
    - **返回值**  
        - 乘法运算的结果:`list[Token]`  

- `division`  
    - **说明**  
        - 计算除法运算，结果化至最简形式  
    - **参数**  
        - `dividend`:`list[Token]` 被除数  
        - `divisor`:`list[Token]` 除数  
    - **实现**  
        - 错误处理：除数为0时抛出异常  
        - 处理特殊情况：被除数为0或除数为1  
        - 处理整数和分数的除法  
        - 处理变量与整数/分数的除法  
        - 复杂表达式的括号处理  
    - **返回值**  
        - 除法运算的结果:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 除数为0时  

- `_negate_expression`  
    - **说明**  
        - 对表达式取反  
    - **参数**  
        - `tokens`:`list[Token]` 要取反的表达式  
    - **实现**  
        - 整数取反直接计算  
        - 分数取反处理分子  
        - 复杂表达式添加负号和括号  
    - **返回值**  
        - 取反后的表达式:`list[Token]`  

- `_create_fraction`  
    - **说明**  
        - 创建分数Token列表，自动化简  
    - **参数**  
        - `numerator`:`int` 分子  
        - `denominator`:`int` 分母  
    - **实现**  
        - 检查分母是否为0  
        - 计算最大公约数进行约分  
        - 处理负号情况  
        - 分母为1返回整数结果  
        - 生成分数Token列表  
    - **返回值**  
        - 分数Token列表:`list[Token]`  
    - **异常**  
        - `OlocCalculationError`: 分母为0时  

## 输入输出  

求值器接受三个参数。  

- `expression`：`str` 输入的表达式(与上一步一致)  
- `tokens`：`list[Token]` 输入的Token流(与上一步一致)  
- `ast`：`ASTTree` 输入的AST树  

求值器的处理结果存储在`self.result`中，是一个包括逐步计算结果的`list[list[Token]]`列表。同时，`self.tokens`，`self.expression`也会更新为最新的结果。    

## 工作流  

求值器按顺序依次执行如下内容。  

1. ***AST树递归求值***  
   - **功能**  
      - 根据AST树的结构递归计算表达式的值      
   - **实现**  
      - 从AST根节点开始，递归计算各子节点    
      - 字面量节点直接返回对应Token    
      - 分组表达式计算内部表达式    
      - 二元表达式计算左右子树，然后执行对应运算符    
      - 一元表达式计算子表达式，然后应用一元运算符    
      - 函数调用计算各参数，然后执行函数操作    
   - **示例**  
      - *输入*: AST树（表示`1+2*3`）  
      - *输出*: `[Token(INTEGER, "7", [0, 0])]`
   - **异常**  
      - `OlocCalculationError`: 当计算过程出现错误（如除零、无效运算）时    

2. ***中间计算状态记录***  
    - **功能**  
      - 记录计算过程中的每一步骤，用于展示计算过程  
    - **实现**   
      - 每完成一个子表达式的计算，记录当前结果  
      - 将每一步的结果添加到`self.result`列表中  
      - 避免添加重复的状态  
    - **示例**  
      - *输入*: `1+2*3`  
      - *输出*: `[[原始Token流], [1, +, 6], [7]]`

3. ***最终结果更新***  
   - **功能**  
      - 完成计算后更新最终结果和表达式  
   - **实现**
      - 更新`self.tokens`为最终计算结果    
      - 调用`Lexer.update`更新表达式字符串    
      - 确保最终结果添加到历史记录中  
   - **示例**  
      - *最终tokens*: `[Token(INTEGER, "7", [0, 0])]`  
      - *最终expression*: `"7"`  

---
***[点此](../项目说明梗概.md)跳转回说明梗概页面***
