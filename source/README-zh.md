# oloc: 一行算式  

> 开发中  

## 概述

`oloc` 是一个轻量的 Python 库,提供了对字符串描述的运算式的基础运算和化简功能.  
`oloc` 非常简单且易于上手--拥有良好的符号兼容性(见符号转换表)以及多样的类型支持(甚至兼容带分数,无限循环小数等).许多情况下,你不需要学习即可直接上手:只需在`oloc.calculation()`中输入你想要计算或化简的算式即可获取结果.  
基于分数运算的设计,其能够很好地保证结果的准确性.`oloc`实现了各种常用的基础运算,包括有理数和无理数的混合运算以及常见的函数:不局限于指数,阶乘等代数函数,还支持如三角函数,对数函数等基础的超越函数.同时,对于稍微进阶一些的用法,`oloc`还可以显示运算的详细过程.而如果计算过程中出现错误,`oloc`完善的异常功能也能提供有效的辅助信息.  
如果你想要在你的程序中集成基础的科学计算功能,那么使用`oloc`将会是一个不错的选择.  

> 本文档针对的`oloc`版本: `alpha-1.0`  

## 安装  

`oloc`已发布在PyPi上.因此,使用`pip`来安装`oloc`:

```bash
pip install oloc
```

随后,在你的项目中使用`oloc`:  
```python
import oloc
```

## 简单使用  

使用`oloc.calculate()`执行运算.函数的参数即为你的计算式.结果以字符串形式返回.  

```python
import oloc
oloc.calculate("1+1") # Output: 2
oloc.calculate("-1/2+1/3") # Output: -1/6
oloc.calculate("cos(pi)*(e^2)") # Output: -e^2
```

> 在继续阅读详细教程前,你可以先根据直觉动手尝试一下.  

## 详细教学  

### 数字  

`oloc`支持有理数和无理数的混合运算.  
在数字前加入一个`-`(负号),将表明该数字为负数.  

#### 有理数  

有理数是`oloc`的核心数字类型.任何有理数在计算的预处理过程中都会被转换为真分数形式.不过,支持的输入类型是多样的.  

##### 整数  

整数指由单纯的阿拉伯数字及一个可选的`-`构成的数.  
以下是一些整数示例:  
`0`,`1`,`-1`,`15`,`100`  

##### 分数  

分数包含分子和分母(不可为0).分数也包含一个可选的`-`,且可以位于分子或分母前.一般建议将`-`放置在分子前以便阅读.以下是一些分数示例:  
`1/2`,`0/-10`,`-314/222`,`50/100`
对于每步计算,`oloc`将自动转化分数指最简形式,即真分数形式,同时将负号化简(如果分子分母同时出现)且移至分子.例如,`2/-4`将被化简为`-1/2`.  
`oloc`也兼容带分数.使用符号`_`或`|`表示.例如,`3_1/2`表示`3+1/2`,`2|-1/4`表示`2+(-1/4)`.带分数将在预处理过程中扫描转化.  

##### 小数

有理小数指由整数位和小数位构成的数.其中,整数位和小数位使用`.`隔开.小数也可以添加一个可选的`-`在开头.  
一些小数示例:
`0.25`,`3.14`,`10500.12345`,`-0.0001`  
`oloc`也兼容无限循环小数.使用3至6个`.`添加到小数结尾表明这是一个无限循环小数.例如,`2.3...`,`123.123......`.  
`oloc`将在预处理中自动扫描最近重复的结构,并转化为分数形式表示.  
也可以显式的指出循环部分:在连续的`.`的结尾,添加上以`:`开头的需要循环的小数部分.如`1.2...:3`等价于`1.233...`.  

#### 无理数   

`oloc`支持无理数.无理数之间支持对应的运算,如果最后的计算结果包含无理数,也会进行相应的保留.  
原生的无理数包括`π`(也可写作`p`,`P`或`pi`,`PI`),`e`或`E`,`𝑒`.  
一些函数的运算结果可能为无理数.对于这些结果,将会对应保留.例如,`√1/2`.  
使用`?`开头并跟随单个英文字母表示自定义无理数.例如`?i`,`?s`.  
使用`<`和`>`并在之间添加非空格的内容也可表示自定义无理数.例如,`<irrationalNumber>`,`<ie.ir>`,`<@sample>`,`<无理数>`.   
> 由于无理数会在计算中保留的特性,你也可以使用无理数当作需要保存的计算结构.因此,`oloc`原生支持`x`,`y`,`z`,`i`,`j`,`k`,`u`,`a`,`b`,`c`,`d`这些常用的未知量符号(及其对应的大写形式)作为无理数使用.  
> 例如,`oloc.calculate(3x/6xy)`的计算结果将是`1/2y`.  

### 运算符  

`oloc`目前支持以下几种主要运算符:

#### 四则运算  

基础的四则运算符号包括`+`,`-`,``,`÷`.  
分数线`/`与除号的含义等价.  
常用的乘法符号包括`*`和`·`.另外,一些情况下乘法符号可以省略:  
- 当数值和括号相连时.如`3*(2+3)`可省略为`3(2+3)`  
- 当数值和无理数相连时.如`2*π/3`可省略为`2π/3`.将无理数做未知数使用时也是如此.如`-6*x`省略为`-6x`  
- 当无理数和无理数相连时.如`π*e`可省略为`πe`.  
- 以上的混合形式.如`3((-2/3x)y)` 

> `oloc`建议使用`+`,`-,`*`,`/`作为四则运算符号.另外,乘法仅在数值与无理数相连,无理数和无理数相连时省略.  

#### 括号

括号用于表达运算的优先级.`(`和`)`是主要的运算符号.括号内的内容将被视为一个整体,并按括号层级进行有限计算.  
一些括号的使用示例:  
```python
oloc.calculate("3/(-1+2)") # Output: 3
oloc.calculate("2*(3+4)") # Output: 14
oloc.calculate("5/(1+1)*(2-1)") # Output: 5/2
```
表达式中可以只使用小括号符号`(`和`)`(也是`oloc`建议的做法).不过,`oloc`也支持显示的区分括号层级.它们从小到大依次是中括号`[`和`]`和大括号`{`和`}`.  
当显示区分括号层级时,级别更小的括号层级必须比级别更大的括号要深.例如,表达式`3+(3/4+[5/6])`将会抛出异常.同时,编写级别更大的括号必须保证已有级别更小的括号存在.例如,`2+{3*[4+1]}`也会抛出异常.    
`oloc`不限制相同级别的括号在不同层级重复出现.例如,`[[2/3π+1]*x]-[sin(π)*(2^1/2-1)]`是一个合法的表达式.  

#### 转化为函数的运算符  

还有一些符号本质上是下一章将讲解到的函数.`oloc`将这些函数提供类似运算符的形式以便于使用.  
示例中,`x`,`y`代表参数.  
包括:  
- `x^y`或`x**y`.其本质为指数函数`pow`.例如,`2^3`(2的3次方)等价`pow(2,3)`  
- `√x`或`┌x`.其本质为开根号,是`pow`函数的变种(即1/2次方).例如,`√1/2`等价`pow(1/2,1/2)`.对于无理数,`√`符号将在结果中保留.例如,`√2` 
- `x%y`.其本质为取余函数.例如,`2%1`等价`mod(2,1)`  
- `|x|`.其本质为绝对值函数.例如,`|-2|`等价`abs(-2)`  
- `x!`.其本质为阶乘函数.例如,`4!`等价为`fact(4)`  
- `x°`或`xdeg`,`xdegree`,`x^o`.其本质上为角度转弧度函数.例如,`30°`等价为`rad(30)`    
- `xrad`或`xradians`.在不指明的情况下,`oloc`默认采用幅度制,因此该运算符会被舍去.例如,`1rad`等价为`1`.    

### 函数  

> 章节未编写完成  

在`oloc`中,函数由函数名和括号内包裹的参数构成.  
> 一个`oloc`计算包含函数的合法表达式示例:  
>   ```python
>    oloc.calculation("pow(2,3)+1/2") # Output:17/2
>   ```
有两种类型的函数:代数函数和超越函数.  

#### 代数函数  

`oloc`支持如下类型的代数函数:(`x`,`y`代表参数)  

- ***指数函数***:`pow(x,y)`  
  - **描述**  
  计算`x`的`y`次方  
  - **性质**  
    - *定义域*  
    `x∈R`,且`y∈R`  
    - *值域*  
    `R`  
  - **变体**  
    - 运算符形式变体:`x^y`和`x**y`,见上文  
    - 开根号函数:`sqrt(x)`.等效于`pow(x,1/2)`  
    - 平方函数:`square(x)`.等效于`pow(x,2)`  
    - 三方函数:`cube(x)`.等效于`pow(x,3)`  
    - 取倒数函数:`reciprocal(x)`.等效于`pow(x,-1)`  
    - e的幂:`exp(x)`.等效于`pow(e,x)`.
  - **示例**  
    ```python
    oloc.calculation("pow(4,1/2)") # Output: 2; Equal: sqrt(4), x^1/2, x**1/2
    oloc.calculate("pow(2, 3)") # Output: 8
    oloc.calculate("pow(16, 1/4)") # Output: 2
    oloc.calculate("pow(-2, 3)") # Output: -8
    oloc.calculate("sqrt(9)") # Output: 3
    oloc.calculate("square(2)") # Output: 4
    oloc.calculate("cube(-3)") # Output: -9
    oloc.calculate("reciprocal(2/3)") # Output: 3/2
    oloc.calculate("exp(2)") # Output: e^2  
    ```
    
- ***阶乘函数***:`fact(x)`  
  - **描述**  
  计算`x`的阶层,即从`1`到`x`所有整数的乘积  
  - **性质**  
    - *定义域*  
    `x∈ℕ`  
    - *值域*  
    `R-{0}`
  - *变体*  
    - 运算符形式变体:`x!`.见上文  
  - **示例**  
    ```python
    oloc.calculate("fact(5)") # Output: 120; Equal: 5!
    oloc.calculate("fact(0)") # Output: 1
    ```

- ***绝对值函数***:`abs(x)`  
- ***符号函数***:`sign(x)`  
- ***最大公约数函数***:`gcd(x,y)`  
- ***最小公倍数函数***:`lcm(x,y)`  

#### 超越函数  

`oloc`支持两类超越函数: 三角函数(含反三角函数)和对数函数.  

### 运算  

> 章节未编写完成  

#### `calculate()`的使用  

`calculate()`是`oloc`对用户所暴露的唯一接口.对`oloc`的使用即为对`calculate`的交互过程.  
`calculate()`的函数定义如下:  
```python
def calculate(expression:str, /, process_list: bool = False, time_limit: int = 5) -> str | list[str]:
    ...
```
*参数说明*:  

#### 运算过程  

> 需要注意的是,`oloc`仅支持实数运算  

在调用`calculation()`后,`oloc`会按照以下顺序依次执行计算.  

##### 预处理  

`oloc`会首先对输入的表达式进行扫描,并通过正则表达式进行预处理.  
对于表达式的预处理的操作包括:  
1. 移除空格  
2. 移除位于表达式最后的`=`(如果有)  
3. 补足被省略的乘号  
4. 将带分数,循环小数转化为分数形式(如果有)  
5. 检查括号层级是否正确,并将所有类型的括号转化为小括号形式(`(`,`)`)(如果有)  
6. 根据符号映射表,将别名的符号转化为相同的统一符号形式  
7. 将所有数值转化为分数形式  
8. 根据函数转换表,将别名的函数转化为相同的统一符号形式  
9. 执行表达式的静态检查  

##### 计算  

##### 其它: 输出还原  

### 异常  

> 章节未编写完成   

`oloc`包含如下自定义异常:  

#### 解析异常  

- ***FormatError***  

- ***FunctionConversionError***  
   
#### 计算异常  

##### 通用计算异常  

- ***DivideByZeroError***  
    - 说明  
    当计算式中出现0作为除数时,抛出此异常  
    - 当异常出现时  
    修改以0作为除数的项   
    - 示例  
    ```python
    oloc.calculate("5/0 % -1/4 =")
    ```
    ```bash
    DivideByZeroError:
    ___
    5/0%-1/4
      ^
    The divisor cannot be 0
    ```
- ***TimeOutError***  
    - 说明  
    当计算式使用超过限制的计算时间未能计算出结果时,抛出此异常  
    - 当异常出现时  
    计算结果过大或计算时间限制过小.修改表达式或计算时长限制(默认为5s)避免此情况发生.另外,计算机性能也有影响.  
    - 示例  
    ```python
    oloc.calculate("10000!", time_limit = 3)
    ```
    ```bash
    TimeOutError:
    10000!
    ^
    The calculation was aborted because it could not be completed within time limit of 3s. Check the range of calculation results
    ```
  
##### 函数计算异常  

- ***FunctionParameterError***  

## 转换表  

> 章节未编写完成

## 示例程序:科学计算器  

> 章节未编写完成  

以下是一个示例程序,提供一个科学计算器终端.同时,利用`simpsave`支持结果及过程的本地存储.  
在运行示例程序前,确保已经通过`pip`安装`oloc`和`simpsave`:

```python
import simpsave as ss
import oloc

FILE_NAME = 'OlocScientificCalculatorDemo.ini' # 存储本地运算

def console(file: str):
    r"""
    """
    print("Oloc Scientific Calculator\n")
    while True:
        expression = input(">>")

if __name__ == '__main__':
    console(FILE_NAME)

```
